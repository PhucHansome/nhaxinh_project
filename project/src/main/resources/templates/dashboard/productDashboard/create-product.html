<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="en">
<head>
    <title>Dashboard | Uplon - Responsive Bootstrap 4 Admin Dashboard</title>
    <th:block th:replace="/dashboard/layout/header::header"/>
</head>
<style>

    .loading {
        position: fixed;
        z-index: 999;
        height: 2em;
        width: 2em;
        overflow: show;
        margin: auto;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
    }

    /* Transparent Overlay */
    .loading:before {
        content: '';
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(rgba(20, 20, 20, .8), rgba(0, 0, 0, .8));

        background: -webkit-radial-gradient(rgba(20, 20, 20, .8), rgba(0, 0, 0, .8));
    }

    /* :not(:required) hides these rules from IE9 and below */
    .loading:not(:required) {
        /* hide "loading..." text */
        font: 0/0 a;
        color: transparent;
        text-shadow: none;
        background-color: transparent;
        border: 0;
    }

    .loading:not(:required):after {
        content: '';
        display: block;
        font-size: 10px;
        width: 1em;
        height: 1em;
        margin-top: -0.5em;
        -webkit-animation: spinner 150ms infinite linear;
        -moz-animation: spinner 150ms infinite linear;
        -ms-animation: spinner 150ms infinite linear;
        -o-animation: spinner 150ms infinite linear;
        animation: spinner 150ms infinite linear;
        border-radius: 0.5em;
        -webkit-box-shadow: rgba(255, 255, 255, 0.75) 1.5em 0 0 0, rgba(255, 255, 255, 0.75) 1.1em 1.1em 0 0, rgba(255, 255, 255, 0.75) 0 1.5em 0 0, rgba(255, 255, 255, 0.75) -1.1em 1.1em 0 0, rgba(255, 255, 255, 0.75) -1.5em 0 0 0, rgba(255, 255, 255, 0.75) -1.1em -1.1em 0 0, rgba(255, 255, 255, 0.75) 0 -1.5em 0 0, rgba(255, 255, 255, 0.75) 1.1em -1.1em 0 0;
        box-shadow: rgba(255, 255, 255, 0.75) 1.5em 0 0 0, rgba(255, 255, 255, 0.75) 1.1em 1.1em 0 0, rgba(255, 255, 255, 0.75) 0 1.5em 0 0, rgba(255, 255, 255, 0.75) -1.1em 1.1em 0 0, rgba(255, 255, 255, 0.75) -1.5em 0 0 0, rgba(255, 255, 255, 0.75) -1.1em -1.1em 0 0, rgba(255, 255, 255, 0.75) 0 -1.5em 0 0, rgba(255, 255, 255, 0.75) 1.1em -1.1em 0 0;
    }

    /* Animation */

    @-webkit-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-moz-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @-o-keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }

    @keyframes spinner {
        0% {
            -webkit-transform: rotate(0deg);
            -moz-transform: rotate(0deg);
            -ms-transform: rotate(0deg);
            -o-transform: rotate(0deg);
            transform: rotate(0deg);
        }
        100% {
            -webkit-transform: rotate(360deg);
            -moz-transform: rotate(360deg);
            -ms-transform: rotate(360deg);
            -o-transform: rotate(360deg);
            transform: rotate(360deg);
        }
    }
</style>
<body>

<!-- Begin page -->
<div id="wrapper">


    <!-- Topbar Start -->
    <th:block th:replace="/dashboard/layout/navbar/navbar::navbar"/>
    <!-- end Topbar -->


    <!-- ========== Left Sidebar Start ========== -->
    <th:block th:replace="/dashboard/layout/left-side-menu::left-side-menu"/>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <div class="container-fluid">

                <div class="row shadow-lg p-2 mb-5 bg-body rounded" style="margin-top: 10px">
                    <div class="col-10">
                    </div>
                    <div class="col-2">
                        <div class="mla float-right" style="font-size: 20px;"></div>
                    </div>
                    <div class="col-md-5">
                        <h6><a href="/product-dashboard">Quay lại danh sách sản phẩm</a></h6>
                    </div>
                    <div class="col-md-7">
                        <button type="button" style="margin-bottom: 10px"
                                class="btn btn-success float-right btn-Save">
                            <i class="fas fa-save"></i>
                            Lưu
                        </button>
                    </div>
                </div>

                <div class="row" style=" position: relative;">
                    <div class="col-md-7">

                        <div class="card-box" style=" position: relative; top: -25px;">
                            <div class="row">
                                <div class="col-md-12">
                                    <h3 style="text-align: center">Thông tin chung</h3>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="ErrorCreate d-none" style="color: red;font-weight: bold;">


                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Tên sản phẩm<span style="color: red">*</span></label>
                                    <input type="text" id="productName" placeholder="Nhập tên sản phẩm"
                                           class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label style="margin-top: 5px">Số lượng</label>
                                    <input type="text" id="quantityProduct" class="form-control">

                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label style="margin-top: 5px">Giá sản phẩm</label>
                                    <input type="text" id="priceProduct" class="form-control">

                                </div>
                                <div class="col-md-6">
                                    <label style="margin-top: 5px">Mã sản phẩm/SKU</label>
                                    <input type="text" id="codeProduct" class="form-control">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label style="margin-top: 5px">kích thước/size</label>
                                    <input type="text" id="productSize" class="form-control">

                                </div>
                                <div class="col-md-6">
                                    <label style="margin-top: 5px">Thể loại/Category</label>
                                    <select id="category_" class="form-control categoryList">
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label style="margin-top: 5px">Màu sắc/Color</label>
                                    <select id="colorProduct" class="form-control productColorList">
                                    </select>
                                </div>
                                <div class="col-md-6"></div>
                            </div>

                            <div class="col-md-12">
                                <div class="container mt-3 w-100">
                                    <div class="card-header d-flex justify-content-between">
                                        <form action="#" class="form" id="form">
                                            <input
                                                    type="file"
                                                    class="d-none"
                                                    multiple
                                                    id="image"
                                                    onchange="page.commands.image_select()"/>

                                            <button class="btn btn-sm btn-danger"
                                                    type="button"
                                                    onclick="document.getElementById('image').click()">
                                                Upload Ảnh Sản Phẩm <i class="fa-solid fa-images"></i>
                                            </button>
                                        </form>
                                    </div>
                                    <div class="row" id="container_"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5" style="  padding-left: 35px;">
                        <div class="card-box"
                             style="position: relative; margin-top: -25px;">
                            <div class="col-md-12">
                                <h6 style="text-align: center">Thông tin bổ sung</h6>
                            </div>
                            <div class="col-md-12">
                                <label>Chất liệu/material</label>
                                <input type="text" id="materialProduct" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label>Tag</label>
                                <input type="text" id="TagProduct" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label>Mô tả sản phẩm</label>
                                <textarea id="descriptionProduct" class="form-control"></textarea>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
            <!-- Start Content-->

            <input type="hidden" style="font-size: 0" id="name_image">
        </div> <!-- end content -->


        <!-- Footer Start -->
        <th:block th:replace="/dashboard/layout/footer::footer"/>
        <!-- end Footer -->

    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->

</div>
<!-- END wrapper -->

<!-- Right Sidebar -->

<!-- Vendor js -->
<th:block th:replace="/dashboard/layout/script/script::script"/>
<script>
    function Ticker(elem) {
        elem.lettering();
        this.done = false;
        this.cycleCount = 5;
        this.cycleCurrent = 0;
        this.chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*()-_=+{}|[]\\;\':"<>?,./`~'.split('');
        this.charsCount = this.chars.length;
        this.letters = elem.find('span');
        this.letterCount = this.letters.length;
        this.letterCurrent = 0;

        this.letters.each(function () {
            var $this = $(this);
            $this.attr('data-orig', $this.text());
            $this.text('-');
        });
    }

    Ticker.prototype.getChar = function () {
        return this.chars[Math.floor(Math.random() * this.charsCount)];
    };

    Ticker.prototype.reset = function () {
        this.done = false;
        this.cycleCurrent = 0;
        this.letterCurrent = 0;
        this.letters.each(function () {
            var $this = $(this);
            $this.text($this.attr('data-orig'));
            $this.removeClass('done');
        });
        this.loop();
    };

    Ticker.prototype.loop = function () {
        var self = this;

        this.letters.each(function (index, elem) {
            var $elem = $(elem);
            if (index >= self.letterCurrent) {
                if ($elem.text() !== ' ') {
                    $elem.text(self.getChar());
                    $elem.css('opacity', Math.random());
                }
            }
        });

        if (this.cycleCurrent < this.cycleCount) {
            this.cycleCurrent++;
        } else if (this.letterCurrent < this.letterCount) {
            var currLetter = this.letters.eq(this.letterCurrent);
            this.cycleCurrent = 0;
            currLetter.text(currLetter.attr('data-orig')).css('opacity', 1).addClass('done');
            this.letterCurrent++;
        } else {
            this.done = true;
        }

        if (!this.done) {
            requestAnimationFrame(function () {
                self.loop();
            });
        } else {
            setTimeout(function () {
                self.reset();
            }, 750);
        }
    };

    $words = $('.word');

    $words.each(function () {
        var $this = $(this),
            ticker = new Ticker($this).reset();
        $this.data('ticker', ticker);
    });
</script>
<script>
    let page = {
        url: {
            CreateProduct: App.BASE_URL_PRODUCT,
            GetProduct: App.BASE_URL_PRODUCT,
            GetCategory: App.BASE_URL_CATEGORY,
            GetProductColor: App.BASE_URL_PRODUCTCOLOR,
            PostProduct: App.BASE_URL_PRODUCT,
            PostTag: App.BASE_URL_TAG + "/id"
        },
        element: {},
        loadData: {},
        commands: {},
        dialogs: {
            element: {},
            loadData: {},
            commands: {},
            close: {},
            alertDanger: {},
            inputError: {}
        }
    }

    let productColor = new ProductColor();
    let category = new Category();
    let product = new Product();
    let tag = new Tag();
    let images = [];
    let formData;

    page.element.priceProduct = $("#priceProduct")
    page.element.productName = $("#productName")
    page.element.quantityProduct = $("#quantityProduct")
    page.element.codeProduct = $("#codeProduct")
    page.element.productSize = $("#productSize")
    page.element.category = $("#category_")
    page.element.categoryText = $("#category_ :selected")
    page.element.colorProduct = $("#colorProduct")
    page.element.colorProductText = $("#colorProduct :selected")
    page.element.productStatus = $("#productStatus")
    page.element.materialProduct = $("#materialProduct")
    page.element.descriptionProduct = $("#descriptionProduct")
    page.element.nameImage = $("#name_image")
    page.element.tag = $("#TagProduct")

    page.element.btnSave = $(".btn-Save")

    page.element.listProductColor = $(".productColorList")
    page.element.ErrorCreate = $(".ErrorCreate")

    page.commands.formatNumber = () => {

        $(document).on('input', '#priceProduct', function (e) {
            $(this).val(App.formatNumberSpace($(this).val()));
        })
        $('input#priceProduct').on("keypress", function (e) {
            let charCode = (e.which) ? e.which : e.keyCode

            if (String.fromCharCode(charCode).match(/[^0-9]/g))
                return false;
        });
    }


    page.dialogs.loadData.drawListCategory = () => {
        $.ajax({
            "type": "GET",
            "url": page.url.GetCategory
        }).done((data) => {
            page.element.category.html('');
            $.each(data, (i, item) => {
                let str = `
                            <option value="${item.id}">${item.name}</option>
                           `;
                page.element.category.append(str);
            })
        }).fail((jqXHR) => {
            console.log(jqXHR);
        })
    }

    page.dialogs.loadData.drawListProductColor = () => {
        $.ajax({
            "type": "GET",
            "url": page.url.GetProductColor
        }).done((data) => {
            page.element.listProductColor.html('');
            $.each(data, (i, item) => {
                let str = `
                           <option class="form-control" value="${item.id}">${item.color}</option>
                          `;
                page.element.listProductColor.append(str);
            })
        }).fail((jqXHR) => {
            console.log(jqXHR);
        })
    }

    page.commands.handleCreateProduct = () => {
        page.element.btnSave.on('click', function () {
            formData.append("code", page.element.codeProduct.val());
            formData.append("title", page.element.productName.val());
            formData.append("price", page.element.priceProduct.val());
            formData.append("quantity", page.element.quantityProduct.val());
            formData.append("status", "Đang chờ");
            formData.append("description", page.element.descriptionProduct.val());
            formData.append("slug", "chua biet lam");
            formData.append("size", page.element.productSize.val());
            formData.append("material", page.element.materialProduct.val());
            formData.append("image", "null");
            let str = `
              <div class="loading">Loading&#8230;</div>
            `
            $(".mla").html(str)
            $.ajax({
                type: "POST",
                contentType: false,
                cache: false,
                processData: false,
                url: page.url.PostProduct + "/" + page.element.category.val() + "/" + page.element.colorProduct.val(),
                data: formData
            }).done((data) => {
                formData.delete("files")
                formData.delete("code");
                formData.delete("title");
                formData.delete("price");
                formData.delete("quantity");
                formData.delete("status");
                formData.delete("description");
                formData.delete("slug");
                formData.delete("size");
                formData.delete("material");
                formData.delete("image");
                product = data;
                delete tag.id
                tag.name = page.element.tag.val();
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "POST",
                    url: page.url.PostTag + "/" + product.id,
                    data: JSON.stringify(tag)
                }).done((item) => {
                    $(".ErrorCreate").addClass("d-none")
                    formData.delete("code");
                    formData.delete("title");
                    formData.delete("price");
                    formData.delete("quantity");
                    formData.delete("status");
                    formData.delete("description");
                    formData.delete("slug");
                    formData.delete("size");
                    formData.delete("material");
                    formData.delete("image");
                    page.element.btnSave.off()
                    $(".mla").html("")
                    page.element.btnSave.off()
                    page.element.priceProduct.val("")
                    page.element.productName.val("")
                    page.element.quantityProduct.val("")
                    page.element.codeProduct.val("")
                    page.element.productSize.val("")
                    page.element.category.val(1)
                    page.element.colorProduct.val(1)
                    page.element.productStatus.val("")
                    page.element.materialProduct.val("")
                    page.element.descriptionProduct.val("")
                    page.element.tag.val("")
                    formData.delete("files")
                    App.IziToast.showSuccessAlert("Bạn Đã Tạo Sản Phẩm Thành công")
                    images = []
                    document.getElementById('container_').innerHTML = page.commands.image_show()
                }).fail((jqXHR) => {
                    console.log(jqXHR)
                    $(".mla").html("")
                    App.IziToast.showErrorAlert("Bạn đã tạo sản phẩm thất bại")
                    formData.delete("files")
                    formData.delete("code");
                    formData.delete("title");
                    formData.delete("price");
                    formData.delete("quantity");
                    formData.delete("status");
                    formData.delete("description");
                    formData.delete("slug");
                    formData.delete("size");
                    formData.delete("material");
                    formData.delete("image");
                    $(".ErrorCreate").removeClass("d-none")
                    $(".ErrorCreate").html("")
                    if (jqXHR.responseJSON) {
                        $.each(jqXHR.responseJSON, (key, item) => {

                            let str = `<ul>
                                    <li>${item}</li>
                                    </ul>
                                `
                            $(".ErrorCreate").append(str)
                        })
                    }
                })
            }).fail((jqXHR) => {
                $(".mla").html("")
                App.IziToast.showErrorAlert("Bạn đã tạo sản phẩm thất bại")
                formData.delete("files")
                formData.delete("code");
                formData.delete("title");
                formData.delete("price");
                formData.delete("quantity");
                formData.delete("status");
                formData.delete("description");
                formData.delete("slug");
                formData.delete("size");
                formData.delete("material");
                formData.delete("image");
                $(".ErrorCreate").removeClass("d-none")
                $(".ErrorCreate").html("")
                if (jqXHR.responseJSON) {
                    console.log(jqXHR)
                    $.each(jqXHR.responseJSON, (key, item) => {

                        let str = `<ul>
                                    <li>${item}</li>
                                    </ul>
                                `
                        $(".ErrorCreate").append(str)
                    })
                }
            })
        })
    }

    page.commands.image_select = () => {
        images = []
        page.element.btnSave.off()
        formData = new FormData()
        let fileInput = $("#image")[0].files;
        if (fileInput.length > 4) {
            App.IziToast.showErrorAlert("chỉ được upload tối đa 4 tấm hình")
            return
        }
        for (let k = 0; k < fileInput.length; k++) {
            formData.append("files", fileInput[k]);
        }
        for (let i = 0; i < fileInput.length; i++) {
            images.push({
                "name": fileInput[i].name,
                "url": URL.createObjectURL(fileInput[i]),
                "file": fileInput[i],
            });
        }
        page.commands.handleCreateProduct();
        document.getElementById('container_').innerHTML = page.commands.image_show()
    }

    page.commands.image_show = () => {
        var image = "";
        images.forEach((i) => {
            image += `
                       <div class="col-3 " style="margin-right: 10px" >
                           <div class="image_container d-flex justify-content-center position-relative">
                            <img style="height: 110px;width: 150px;"  src="` + i.url + `"  alt="" />
                             <span class="position-absolute" onclick="page.commands.delete_image(` + images.indexOf(i) + `)">&times;</span>
                          </div>
                      </div>
                    `;
        })
        return image;
    }
    page.commands.delete_image = (e) => {
        images.splice(e, 1)
        let arrFile = formData.getAll("files")
        arrFile.splice(e, 1)
        formData.delete("files")
        for (let i = 0; i < arrFile.length; i++) {
            formData.append("files", arrFile[i])
        }
        document.getElementById("container_").innerHTML = page.commands.image_show();
    }

    $(function () {
        page.dialogs.loadData.drawListCategory();
        page.dialogs.loadData.drawListProductColor();
        page.commands.formatNumber();

    })
</script>
</body>
</html>