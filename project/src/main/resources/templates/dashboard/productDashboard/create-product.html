<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html" lang="en">
<head>
    <title>Dashboard | Uplon - Responsive Bootstrap 4 Admin Dashboard</title>
    <th:block th:replace="/dashboard/layout/header::header"/>
</head>
<style>

    h2 {
        color: #ccc;
        margin: 0;
        font: .8em verdana;
        text-transform: uppercase;
        letter-spacing: .1em;
        text-align: center;
    }

    /*
     * Loading Dots
     * Can we use pseudo elements here instead :after?
     */
    .loading span {
        display: inline-block;
        vertical-align: middle;
        width: .6em;
        height: .6em;
        margin: .19em;
        background: #31373b;
        border-radius: .6em;
        animation: loading 1s infinite alternate;
    }

    /*
     * Dots Colors
     * Smarter targeting vs nth-of-type?
     */
    .loading span:nth-of-type(2) {
        background: #396570;
        animation-delay: 0.2s;
    }

    .loading span:nth-of-type(3) {
        background: #009B9E;
        animation-delay: 0.4s;
    }

    .loading span:nth-of-type(4) {
        background: #00A77D;
        animation-delay: 0.6s;
    }

    .loading span:nth-of-type(5) {
        background: #00B247;
        animation-delay: 0.8s;
    }

    .loading span:nth-of-type(6) {
        background: #5AB027;
        animation-delay: 1.0s;
    }

    .loading span:nth-of-type(7) {
        background: #c9324e;
        animation-delay: 1.2s;
    }

    /*
     * Animation keyframes
     * Use transition opacity instead of keyframes?
     */
    @keyframes loading {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }
</style>
<body>

<!-- Begin page -->
<div id="wrapper">


    <!-- Topbar Start -->
    <th:block th:replace="/dashboard/layout/navbar/navbar::navbar"/>
    <!-- end Topbar -->


    <!-- ========== Left Sidebar Start ========== -->
    <th:block th:replace="/dashboard/layout/left-side-menu::left-side-menu"/>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <div class="container-fluid">

                <div class="row shadow-lg p-2 mb-5 bg-body rounded" style="margin-top: 10px">
                    <div class="col-10">
                    </div>
                    <div class="col-2">
                        <div class="mla float-right" style="font-size: 20px;"></div>
                    </div>
                    <div class="col-md-5">
                        <h6><a href="/product-dashboard">Quay lại danh sách sản phẩm</a></h6>
                    </div>
                    <div class="col-md-7">
                        <button type="button" style="margin-bottom: 10px"
                                class="btn btn-success float-right btn-Save">
                            <i class="fas fa-save"></i>
                            Lưu
                        </button>
                    </div>
                </div>

                <div class="row" style=" position: relative;">
                    <div class="col-md-7">

                        <div class="row shadow-lg p-3 mb-5 bg-body rounded" style=" position: relative; top: -25px;">
                            <div class="col-md-12">
                                <h6 style="text-align: center">Thông tin chung</h6>
                            </div>

                            <div class="col-md-6">
                                <label>Tên sản phẩm<span style="color: red">*</span></label>
                                <input type="text" id="productName" placeholder="Nhập tên sản phẩm"
                                       class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label style="margin-top: 5px">Số lượng</label>
                                <input type="text" id="quantityProduct" class="form-control">

                            </div>
                            <div class="col-md-6">
                                <label style="margin-top: 5px">Giá sản phẩm</label>
                                <input type="text" id="priceProduct" class="form-control">

                            </div>
                            <div class="col-md-6">
                                <label style="margin-top: 5px">Mã sản phẩm/SKU</label>
                                <input type="text" id="codeProduct" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label style="margin-top: 5px">kích thước/size</label>
                                <input type="text" id="productSize" class="form-control">

                            </div>
                            <div class="col-md-6">
                                <label style="margin-top: 5px">Thể loại/Category</label>
                                <select id="category_" class="form-control categoryList">
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label style="margin-top: 5px">Màu sắc/Color</label>
                                <select id="colorProduct" class="form-control productColorList">
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label style="margin-top: 5px">Trạng thái/status</label>
                                <select id="productStatus" class="form-control">
                                    <option>Đã Hết Hàng</option>
                                    <option>Còn Hàng</option>
                                </select>
                            </div>
                            <div class="col-md-6"></div>
                            <div class="col-md-12">
                                <div class="container mt-3 w-100">
                                    <div class="card-header d-flex justify-content-between">
                                        <form action="#" class="form" id="form">
                                            <input
                                                    type="file"
                                                    class="d-none"
                                                    multiple
                                                    id="image"
                                                    onchange="page.commands.image_select()"/>

                                            <button class="btn btn-sm btn-danger"
                                                    type="button"
                                                    onclick="document.getElementById('image').click()">
                                                Upload Ảnh Sản Phẩm <i class="fa-solid fa-images"></i>
                                            </button>
                                        </form>
                                    </div>
                                    <div class="card-body d-flex justify-content-start" id="container_"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5" style="  padding-left: 35px;">
                        <div class="row shadow-lg p-3 mb-5 bg-body rounded"
                             style="position: relative; margin-top: -25px;">
                            <div class="col-md-12">
                                <h6 style="text-align: center">Thông tin bổ sung</h6>
                            </div>
                            <div class="col-md-12">
                                <label>Chất liệu/material</label>
                                <input type="text" id="materialProduct" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label>Tag</label>
                                <input type="text" id="TagProduct" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label>Mô tả sản phẩm</label>
                                <textarea id="descriptionProduct" class="form-control"></textarea>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
            <!-- Start Content-->

            <input type="hidden" style="font-size: 0" id="name_image">
        </div> <!-- end content -->


        <!-- Footer Start -->
        <th:block th:replace="/dashboard/layout/footer::footer"/>
        <!-- end Footer -->

    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->

</div>
<!-- END wrapper -->

<!-- Right Sidebar -->

<!-- Vendor js -->
<th:block th:replace="/dashboard/layout/script/script::script"/>
<script>
    function Ticker(elem) {
        elem.lettering();
        this.done = false;
        this.cycleCount = 5;
        this.cycleCurrent = 0;
        this.chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&*()-_=+{}|[]\\;\':"<>?,./`~'.split('');
        this.charsCount = this.chars.length;
        this.letters = elem.find('span');
        this.letterCount = this.letters.length;
        this.letterCurrent = 0;

        this.letters.each(function () {
            var $this = $(this);
            $this.attr('data-orig', $this.text());
            $this.text('-');
        });
    }

    Ticker.prototype.getChar = function () {
        return this.chars[Math.floor(Math.random() * this.charsCount)];
    };

    Ticker.prototype.reset = function () {
        this.done = false;
        this.cycleCurrent = 0;
        this.letterCurrent = 0;
        this.letters.each(function () {
            var $this = $(this);
            $this.text($this.attr('data-orig'));
            $this.removeClass('done');
        });
        this.loop();
    };

    Ticker.prototype.loop = function () {
        var self = this;

        this.letters.each(function (index, elem) {
            var $elem = $(elem);
            if (index >= self.letterCurrent) {
                if ($elem.text() !== ' ') {
                    $elem.text(self.getChar());
                    $elem.css('opacity', Math.random());
                }
            }
        });

        if (this.cycleCurrent < this.cycleCount) {
            this.cycleCurrent++;
        } else if (this.letterCurrent < this.letterCount) {
            var currLetter = this.letters.eq(this.letterCurrent);
            this.cycleCurrent = 0;
            currLetter.text(currLetter.attr('data-orig')).css('opacity', 1).addClass('done');
            this.letterCurrent++;
        } else {
            this.done = true;
        }

        if (!this.done) {
            requestAnimationFrame(function () {
                self.loop();
            });
        } else {
            setTimeout(function () {
                self.reset();
            }, 750);
        }
    };

    $words = $('.word');

    $words.each(function () {
        var $this = $(this),
            ticker = new Ticker($this).reset();
        $this.data('ticker', ticker);
    });
</script>
<script>
    let page = {
        url: {
            CreateProduct: App.BASE_URL_PRODUCT,
            GetProduct: App.BASE_URL_PRODUCT,
            GetCategory: App.BASE_URL_CATEGORY,
            GetProductColor: App.BASE_URL_PRODUCTCOLOR,
            PostProduct: App.BASE_URL_PRODUCT,
            PostTag: App.BASE_URL_TAG + "/id"
        },
        element: {},
        loadData: {},
        commands: {},
        dialogs: {
            element: {},
            loadData: {},
            commands: {},
            close: {},
            alertDanger: {},
            inputError: {}
        }
    }

    let productColor = new ProductColor();
    let category = new Category();
    let product = new Product();
    let tag = new Tag();
    let images = [];
    let formData;

    page.element.priceProduct = $("#priceProduct")
    page.element.productName = $("#productName")
    page.element.quantityProduct = $("#quantityProduct")
    page.element.codeProduct = $("#codeProduct")
    page.element.productSize = $("#productSize")
    page.element.category = $("#category_")
    page.element.categoryText = $("#category_ :selected")
    page.element.colorProduct = $("#colorProduct")
    page.element.colorProductText = $("#colorProduct :selected")
    page.element.productStatus = $("#productStatus")
    page.element.materialProduct = $("#materialProduct")
    page.element.descriptionProduct = $("#descriptionProduct")
    page.element.nameImage = $("#name_image")
    page.element.tag = $("#TagProduct")

    page.element.btnSave = $(".btn-Save")

    page.element.listProductColor = $(".productColorList")

    page.dialogs.loadData.drawListCategory = () => {
        $.ajax({
            "type": "GET",
            "url": page.url.GetCategory
        }).done((data) => {
            page.element.category.html('');
            $.each(data, (i, item) => {
                let str = `
                            <option value="${item.id}">${item.name}</option>
                           `;
                page.element.category.append(str);
            })
        }).fail((jqXHR) => {
            console.log(jqXHR);
        })
    }

    page.dialogs.loadData.drawListProductColor = () => {
        $.ajax({
            "type": "GET",
            "url": page.url.GetProductColor
        }).done((data) => {
            page.element.listProductColor.html('');
            $.each(data, (i, item) => {
                let str = `
                           <option class="form-control" value="${item.id}">${item.color}</option>
                          `;
                page.element.listProductColor.append(str);
            })
        }).fail((jqXHR) => {
            console.log(jqXHR);
        })
    }

    page.commands.handleCreateProduct = () => {
        page.element.btnSave.on('click', function () {
            formData.append("code", page.element.codeProduct.val());
            formData.append("title", page.element.productName.val());
            formData.append("price", page.element.priceProduct.val());
            formData.append("quantity", page.element.quantityProduct.val());
            formData.append("status", page.element.productStatus.val());
            formData.append("description", page.element.descriptionProduct.val());
            formData.append("slug", "chua biet lam");
            formData.append("size", page.element.productSize.val());
            formData.append("material", page.element.materialProduct.val());
            formData.append("image", "null");
            let str = `
            <div class="loading">
                    <h2>Loading</h2>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                    </div>
            `
            $(".mla").html(str)
            $.ajax({
                type: "POST",
                contentType: false,
                cache: false,
                processData: false,
                url: page.url.PostProduct + "/" + page.element.category.val() + "/" + page.element.colorProduct.val(),
                data: formData
            }).done((data) => {
                product = data;
                delete tag.id
                tag.name = page.element.tag.val();
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "POST",
                    url: page.url.PostTag +"/"+ product.id,
                    data: JSON.stringify(tag)
                }).done((item) => {
                    formData.delete("code");
                    formData.delete("title");
                    formData.delete("price");
                    formData.delete("quantity");
                    formData.delete("status");
                    formData.delete("description");
                    formData.delete("slug");
                    formData.delete("size");
                    formData.delete("material");
                    formData.delete("image");
                    page.element.btnSave.off()
                    console.log(item)
                    $(".mla").remove()
                    page.element.priceProduct.val("")
                    page.element.productName.val("")
                    page.element.quantityProduct.val("")
                    page.element.codeProduct.val("")
                    page.element.productSize.val("")
                    page.element.category.val(1)
                    page.element.colorProduct.val(1)
                    page.element.productStatus.val("")
                    page.element.materialProduct.val("")
                    page.element.descriptionProduct.val("")
                    formData.delete("files")
                    App.IziToast.showSuccessAlert("Bạn Đã Tạo Sản Phẩm Thành công")
                    images = []
                    document.getElementById('container_').innerHTML = page.commands.image_show()
                }).fail((e) => {
                    console.log(e)
                    $(".mla").remove()
                    App.IziToast.showErrorAlert("Bạn đã tạo sản phẩm thất bại")
                })
            }).fail(() => {
                $(".mla").remove()
                App.IziToast.showErrorAlert("Bạn đã tạo sản phẩm thất bại")
            })
        })
    }

    page.commands.image_select = () => {
        images = []
        page.element.btnSave.off()
        formData = new FormData()
        let fileInput = $("#image")[0].files;
        if (fileInput.length > 4) {
            App.IziToast.showErrorAlert("chỉ được upload tối đa 4 tấm hình")
            return
        }
        for (let k = 0; k < fileInput.length; k++) {
            formData.append("files", fileInput[k]);
        }
        for (let i = 0; i < fileInput.length; i++) {
            images.push({
                "name": fileInput[i].name,
                "url": URL.createObjectURL(fileInput[i]),
                "file": fileInput[i],
            });
        }
        page.commands.handleCreateProduct();
        document.getElementById('container_').innerHTML = page.commands.image_show()
    }

    page.commands.image_show = () => {
        var image = "";
        images.forEach((i) => {
            image += `<div class="image_container d-flex justify-content-center position-relative">
                        <img src="` + i.url + `"  alt="" />
                         <span class="position-absolute" onclick="page.commands.delete_image(` + images.indexOf(i) + `)">&times;</span>
                      </div>
                    `;
        })
        return image;
    }
    page.commands.delete_image = (e) => {
        images.splice(e, 1)
        let arrFile = formData.getAll("files")
        arrFile.splice(e, 1)
        formData.delete("files")
        for (let i = 0; i < arrFile.length; i++) {
            formData.append("files", arrFile[i])
        }
        document.getElementById("container_").innerHTML = page.commands.image_show();
    }

    $(function () {
        page.dialogs.loadData.drawListCategory();
        page.dialogs.loadData.drawListProductColor();
    })
</script>
</body>
</html>